// WoWoKitchen - Prisma Schema

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "mysql"
}

// ==================== 用户 ====================
model User {
  id           Int          @id @default(autoincrement())
  username     String       @unique
  passwordHash String
  createdAt    DateTime     @default(now())
  ingredients  Ingredient[]
  dishes       Dish[]
  menus        Menu[]
  parties      Party[]
}

// ==================== 食材 ====================
model Ingredient {
  id        Int              @id @default(autoincrement())
  name      String
  unitPrice Float            // 采购单价
  spec      String           // 采购规格，如 "500g/包"
  userId    Int
  user      User             @relation(fields: [userId], references: [id])
  dishes    DishIngredient[]
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  @@unique([name, userId])   // 同一用户不允许重名食材
}

// ==================== 菜品 ====================
model Dish {
  id            Int              @id @default(autoincrement())
  name          String
  estimatedCost Float            @default(0) // 自动计算的预估成本
  userId        Int
  user          User             @relation(fields: [userId], references: [id])
  ingredients   DishIngredient[]
  menus         MenuDish[]
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
}

// ==================== 菜品-食材关联 (BOM) ====================
model DishIngredient {
  id           Int        @id @default(autoincrement())
  dishId       Int
  ingredientId Int
  quantity     Float      // 消耗量
  unit         String     // 单位（g, 个, ml 等）
  dish         Dish       @relation(fields: [dishId], references: [id], onDelete: Cascade)
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id])

  @@unique([dishId, ingredientId]) // 同一菜品中同一食材只出现一次
}

// ==================== 菜单集 ====================
model Menu {
  id        Int        @id @default(autoincrement())
  name      String
  userId    Int
  user      User       @relation(fields: [userId], references: [id])
  dishes    MenuDish[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

// ==================== 菜单-菜品关联 ====================
model MenuDish {
  id     Int  @id @default(autoincrement())
  menuId Int
  dishId Int
  menu   Menu @relation(fields: [menuId], references: [id], onDelete: Cascade)
  dish   Dish @relation(fields: [dishId], references: [id])

  @@unique([menuId, dishId])
}

// ==================== 分享码 (6位短码) ====================
model ShareToken {
  code      String   @id // 6位随机码
  type      String   // "DISH" | "MENU"
  refId     Int      // 关联的 DishId 或 MenuId
  userId    Int      // 创建者
  createdAt DateTime @default(now())
  expiresAt DateTime? // 可选过期时间
}

// ==================== 饭局 ====================
model Party {
  id        Int          @id @default(autoincrement())
  name      String
  status    String       @default("ACTIVE") // ACTIVE | LOCKED
  shareCode String       @unique            // 饭局本身的分享码 (6位)
  hostId    Int
  host      User         @relation(fields: [hostId], references: [id])
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  
  // 饭局的"菜品池" (由 Host 添加，供 Guest 选择)
  poolDishes PartyDishPool[]

  // 饭局的宾客
  guests     PartyGuest[]
}

// ==================== 饭局菜品池 (备选池) ====================
model PartyDishPool {
  id                  Int      @id @default(autoincrement())
  partyId             Int
  dishName            String                // 菜品名称快照
  ingredientsSnapshot String   @db.Text     // JSON: [{name, quantity, unit, unitPrice, spec}]
  costSnapshot        Float                 // 成本快照
  originalDishId      Int?                  // 关联的原菜品ID (可选)
  
  party               Party    @relation(fields: [partyId], references: [id], onDelete: Cascade)
  
  // 哪些宾客选择了这道菜
  selections          GuestSelection[]

  createdAt           DateTime @default(now())
}

// ==================== 饭局宾客 ====================
model PartyGuest {
  id         Int              @id @default(autoincrement())
  partyId    Int
  nickname   String
  guestToken String           @unique // 游客身份标识 (UUID)
  
  party      Party            @relation(fields: [partyId], references: [id], onDelete: Cascade)
  
  // 宾客选择的菜品
  selections GuestSelection[]
  
  createdAt  DateTime         @default(now())
}

// ==================== 宾客选菜关联 ====================
model GuestSelection {
  id        Int           @id @default(autoincrement())
  guestId   Int
  poolDishId Int
  
  guest     PartyGuest    @relation(fields: [guestId], references: [id], onDelete: Cascade)
  poolDish  PartyDishPool @relation(fields: [poolDishId], references: [id], onDelete: Cascade)

  @@unique([guestId, poolDishId]) // 同一宾客对同一菜品只能选一次
}
